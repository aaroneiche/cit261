<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="rover.css">
    <title>Document</title>
</head>
<body>
    <h1>Rover Photo Explorer</h1>

    <!-- Generic Container -->
    <div id="container">
        <div id="card" class="">
            <div id="rovers" class="face front">
                <div class="loader">
                    <img src="marsspinning.gif" alt="" height=30 width=30>
                </div>                    
                <!-- <button onclick="toggleCard(null)">Go to Rover</button> -->
                <div class="rover" id="opportunity" data-img="rover/opportunity.jpg"></div>
                <div class="rover" id="spirit" data-img="rover/spirit.jpg"></div>        
                <div class="rover" id="curiosity" data-img="rover/curiosity.jpg"></div>
                <div id="introduction">
                    Did you know that Mars is a planet populated entirely by robots? It's true.
                    Humanity has been sending robotic probes to Mars since 1975 with the Viking 1. 
                    In the last couple of decades we've put a few rovers - mobile science labs 
                    on the red planet. NASA has kindly <a href="https://api.nasa.gov/api.html" target="_blank">provided an API</a>
                    to view images taken by these robots.
                    Click on a Rover above for more information and to browse images.
                    Please note that the Curiosity rover has a LOT of data, it will take some time to load.
                </div>
            </div>
            <div id="rover_details" class="face back">
                <div class="title"></div>
                <div id="layout">
                    <div id="rover_info">
                        <table>
                            <tr><th>Launch Date: </th>    <td id="launch_date"></td></tr>
                            <tr><th>Landing Date: </th>  <td id="land_date"></td></tr>
                            <tr><th>Status: </th><td id="status"></td></tr>
                            <tr><th>Total Photos: </th><td id="total_photos"></td></tr>
                            <tr><th colspan="2">Cameras: </th></tr>
                            <tr>
                                <td id="camera_list" colspan="2"></td>
                            </tr>
                        </table>
                    </div>
                    <div id="rover_pic">
                        <div>Select a camera on the left to view images </div>
                        <select name="pictures" id="pictures" multiple>
                            
                        </select>
                    </div>
                </div>
                <button onclick="toggleCard()">Back to Rovers</button>
            </div>
        </div>
    </div>
    <div id="photo">
        <img id="roverPhoto" src="" alt="">
        
        <!-- <div id="imageContainer">    
            <img id="photoLoader" src="marsspinning.gif" alt="" height=30 width=30>
        </div>    -->
    </div>
    <script>
    
        var data = {};
        let rover = "curiosity"; //Set a default

        //Handle on page load.
        document.addEventListener('DOMContentLoaded',e=>{

            document.querySelector("#photo").addEventListener("click",e=>{
                document.querySelector("#photo").style.visibility = "hidden";
                document.querySelector("#photo img").src = "";
            })

            var rovers = document.querySelectorAll(".rover");
            
            rovers.forEach(e=>{
                e.addEventListener("click",r=>{
                    // toggleCard();
                    getRoverDetails(r.target.id);
                });
            })

            

        });

        function toggleCard() {
            document.getElementById("card").classList.toggle("flipped");
        }

        function displayRoverDetails() {

            rover = data.photos[0].rover;

            document.querySelector("#rover_details .title").innerHTML = rover.name;
            
            document.querySelector("td#launch_date").innerHTML = rover.launch_date;
            document.querySelector("td#land_date").innerHTML = rover.landing_date;
            document.querySelector("td#status").innerHTML = rover.status;
            document.querySelector("td#total_photos").innerHTML = rover.total_photos;

            rover.cameras.push({"name":"all", "full_name":"All Cameras"});

            //Clear the camera list.
            document.querySelector("td#camera_list").innerHTML = "";
            rover.cameras.forEach(c=>{
                let cam = document.createElement("li");
                cam.setAttribute("data-cam",c.name);
                cam.innerHTML = c.full_name;
                
                cam.addEventListener("click", ev => {
                    listImages(ev.target.getAttribute("data-cam"));
                })

                document.querySelector("td#camera_list").appendChild(cam);
            })
        }


        function getRoverDetails(rover) {
            var url = "https://api.nasa.gov/mars-photos/api/v1/rovers/" + rover + "/photos?sol=1000&api_key=DEMO_KEY";

            //Create an XMLHttpRequest.
            var r = new XMLHttpRequest();
            r.open("GET",url);
            
            //Set a loading spinner.

            document.querySelector(".loader").style.left = document.querySelector("#" + rover).offsetLeft + "px";
            document.querySelector(".loader").style.visibility = "visible";

            //ES2015 approach. You could easily do:
            // r.onload = function (){ ...
            r.onload = () => {
                if(r.status == 200) {
                    data = JSON.parse(r.responseText);
                    // return new Promise().resolve(r.responseText);
                    displayRoverDetails();
                    toggleCard();
                    // document.querySelector(".rover div.loader").classList.remove("show");
                    document.querySelector(".loader").style.visibility = "hidden";
                }else{
                    //probably an error - possibly a 3xx status code.
                    alert("Error communicating with NASA");
                }
            }
            r.send();
        }    
    
        function listImages(camera) {
            let photoSet = data.photos.filter(p=>{
                return p.camera.name == camera;
            });

            document.querySelector("#pictures").innerHTML = "";

            if(photoSet.length > 0 ) {
                photoSet.forEach(p=>{
                    let op = document.createElement("option");
                    op.innerHTML = `ID: ${p.id} Date:${p.earth_date} Sol: ${p.sol}`
                    op.setAttribute("data-img",p.img_src);
                    op.addEventListener("click", e=>{
                        showPicture(e.target.getAttribute("data-img"));
                    })
                    document.querySelector("#pictures").appendChild(op);
                });
            }else{
                let op = document.createElement("option");
                op.innerHTML = "No images for this Camera";
                document.querySelector("#pictures").appendChild(op);
            }
        }
    
        function showPicture(imageUrl) {
            let img = document.querySelector("#photo img");
            img.setAttribute("src",imageUrl);
            document.querySelector("#photo").style.visibility = "visible";


        }
    </script>

</body>
</html>