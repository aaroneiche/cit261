<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="canvas.css" />
    <title>Document</title>
</head>
<body>
    <div id="controls">
        <button onclick="play();">Play</button>
        <button onclick="pause();">Pause</button>
        <button onclick="toggleTimestamp()">Timestamp</button>
    </div>
    <div id="container">
        <canvas id="canvas" class="over"></canvas>
        <video id="video" src="modern_times.mp4" class="over"></video>
        <audio id="audio">
            <source src="pop.wav" type="audio/wav">
            Your browser does not support the audio tag.
        </audio>
    </div>

    <script>

        //Global definitions
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");
        var audio = document.getElementById("audio");
        var ctx = canvas.getContext("2d");

        //Each of these should have their own draw methdo to call.
        var animateObjects = [];

        var timestamp = new Timestamp(ctx);
        timestamp.animate = true;

        /* 
        Draws a "pop up video" bubble.
        */
        function drawBubble(context, x, y, radius, width){

            // let radius = 20;
            let lineWidth = 2;

            //left Arc
            context.beginPath();
            context.arc(x,y,radius, 0.5 * Math.PI, 1.5 * Math.PI);
            context.fillStyle = "#fff";
            context.fill();
            context.strokeStyle = "#000";
            context.lineWidth = lineWidth;
            context.stroke();

            //top line
            context.beginPath();
            context.moveTo(x,y - radius);
            context.lineTo(x + width,y - radius);
            context.stroke();

            //bottom line
            context.beginPath();
            context.moveTo(x,y + radius);
            context.lineTo(x + width,y + radius);
            context.stroke();

            //fill background
            context.fillStyle = "#fff";
            context.fillRect(x, y - radius + (lineWidth/2), width, (radius * 2) - lineWidth);

            //right arc
            context.beginPath();
            context.arc(x + width,y,radius, 1.5 * Math.PI, 0.5 * Math.PI);
            context.fillStyle = "#fff";
            context.fill();
            context.strokeStyle = "#000";
            context.lineWidth = lineWidth;
            context.stroke();
        }

        function drawTest(){
            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");

            var radius = 20;
            ctx.beginPath();
            ctx.arc(100,60, 30, 2 * Math.PI, false);    
            
            ctx.fillStyle = 'green';
            ctx.fill();
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#003300';
            ctx.stroke();
        }
    
        //Popup object.
        function PopUp(text, x, y, startTime, endTime, context) {
            this.text = text
            this.x = x;
            this.y = y;
            this.radius = 0;
            this.width = 0;
            this.startTime = startTime;
            this.endTime = endTime;
            this.animate = true; //Whether the popup should be drawn or not.
            this.audioPlayed = false;

            this.currentRadius = 0; //initialize to not-visible.
            this.currentWidth = 0; //Initial the initial width.

            //Previously these were arguments. They should be calculated instead.
            let radius = 10;
            // let width = 4.6 * text.length; //Calculated by emperical testing.
            let width = 6.35 * text.length; //Calculated by emperical testing.

            //target values are set at initialization. They are not exposed.
            let targetWidth = width;
            let targetRadius = radius;

            this.draw = function(){
                
                if(this.audioPlayed === false && timestamp.currentTime > this.startTime) {
                    audio.play();
                    this.audioPlayed = true;
                }

                if(timestamp.currentTime > this.startTime && timestamp.currentTime < this.endTime) {
                    if(this.radius < targetRadius) {
                        this.radius += 2;
                    }else if(this.width < targetWidth) {
                        this.width += 15;
                    }
                    this.time -= 1; //Decrement time, described in frames.
                    drawBubble(context, this.x, this.y, this.radius, this.width);

                    context.save();
                    context.beginPath();
                    
                    // context.fillStyle = "#f00"
                    // context.fillRect(this.x,this.y - this.radius, this.width, radius * 2);
                    
                    context.rect(this.x,this.y - this.radius, this.width, radius * 2);
                    context.clip();
                    context.font = "14px Arial";
                    context.fillStyle = "#000";
                    context.fillText(this.text, this.x, this.y + 4);
                    context.restore();
                }
            }
        }

        function play(){
            document.getElementById("video").play();
        }
        
        function pause(){
            document.getElementById("video").pause();
        }
    
        function Timestamp(context) {
            this.animate = true;
            this.currentTime = 0;
            this.draw = ()=> {              
                this.currentTime = document.querySelector("#video").currentTime;
                context.font = "20px Arial";
                context.fillStyle = "#000"
                // context.

                context.fillText(this.currentTime, 300, 20);
            }
        }

        document.addEventListener('DOMContentLoaded',e=>{
            //Add initial animation items
            animateObjects.push(new PopUp("Modern times was released in February, 1936 by United Artists", 100, 100, 0.5, 4.0, ctx));
            animateObjects.push(new PopUp("Chaplin originally planned for it to be his first 'talkie'", 160, 320, 5.7, 9.5, ctx));
            animateObjects.push(new PopUp("After experimenting, he decided the appeal of 'the little tramp' would be lost if he ever spoke.", 10, 20, 12, 16, ctx));
            animateObjects.push(timestamp);

            animate(); // start the animation right away.
        });

        // after the video's loaded, set the canvas size.
        document.getElementById("video").addEventListener('loadeddata',e=>{
            //Sets the canvas size relative to the device it's on. Fixes resolution issues.
            canvas.width = video.getBoundingClientRect().width;
            canvas.height = video.getBoundingClientRect().height;
        });

        function animate() {
            //Clear the canvas before each frame.
            ctx.clearRect(0,0,canvas.width, canvas.height);

            animateObjects.forEach(element => {
                if(element.animate == true){
                    element.draw();
                }
            });
            setTimeout(animate,1000/60);
        }

        function toggleTimestamp() {
            timestamp.animate = !timestamp.animate;
        }

    </script>
  </body>
</html>